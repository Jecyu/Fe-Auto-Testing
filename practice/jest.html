<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Jest | 前端自动化测试</title>
    <meta name="description" content="Analysis vue.js deeply">
    <link rel="icon" href="/Fe-Auto-Testing/logo.png">
  <link rel="manifest" href="/Fe-Auto-Testing/manifest.json">
  <meta name="theme-color" content="#3eaf7c">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" href="/Fe-Auto-Testing/icons/apple-touch-icon-152x152.png">
  <link rel="mask-icon" href="/Fe-Auto-Testing/icons/safari-pinned-tab.svg" color="#3eaf7c">
  <meta name="msapplication-TileImage" content="/icons/msapplication-icon-144x144.png">
  <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/Fe-Auto-Testing/assets/css/0.styles.3ae066cf.css" as="style"><link rel="preload" href="/Fe-Auto-Testing/assets/js/app.092a0afe.js" as="script"><link rel="preload" href="/Fe-Auto-Testing/assets/js/3.b3f65018.js" as="script"><link rel="prefetch" href="/Fe-Auto-Testing/assets/js/10.2106dc5c.js"><link rel="prefetch" href="/Fe-Auto-Testing/assets/js/11.c60ed52a.js"><link rel="prefetch" href="/Fe-Auto-Testing/assets/js/12.9068df64.js"><link rel="prefetch" href="/Fe-Auto-Testing/assets/js/13.02765de5.js"><link rel="prefetch" href="/Fe-Auto-Testing/assets/js/14.526ade17.js"><link rel="prefetch" href="/Fe-Auto-Testing/assets/js/15.9f362ddf.js"><link rel="prefetch" href="/Fe-Auto-Testing/assets/js/16.cd7414cf.js"><link rel="prefetch" href="/Fe-Auto-Testing/assets/js/17.7bed77b4.js"><link rel="prefetch" href="/Fe-Auto-Testing/assets/js/18.458df518.js"><link rel="prefetch" href="/Fe-Auto-Testing/assets/js/19.39a58d89.js"><link rel="prefetch" href="/Fe-Auto-Testing/assets/js/2.3a8ead68.js"><link rel="prefetch" href="/Fe-Auto-Testing/assets/js/20.70a7fc52.js"><link rel="prefetch" href="/Fe-Auto-Testing/assets/js/21.473e6975.js"><link rel="prefetch" href="/Fe-Auto-Testing/assets/js/4.09b9b62a.js"><link rel="prefetch" href="/Fe-Auto-Testing/assets/js/5.e11b96bb.js"><link rel="prefetch" href="/Fe-Auto-Testing/assets/js/6.19a7a933.js"><link rel="prefetch" href="/Fe-Auto-Testing/assets/js/7.9dc0e2dd.js"><link rel="prefetch" href="/Fe-Auto-Testing/assets/js/8.2689fee4.js"><link rel="prefetch" href="/Fe-Auto-Testing/assets/js/9.ec96d22d.js">
    <link rel="stylesheet" href="/Fe-Auto-Testing/assets/css/0.styles.3ae066cf.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/Fe-Auto-Testing/" class="home-link router-link-active"><!----> <span class="site-name">前端自动化测试</span></a> <div class="links" style="max-width:nullpx;"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://github.com/Jecyu/Fe-Auto-Testing/tree/master" target="_blank" rel="noopener noreferrer" class="nav-link external">
  配套例子
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/Jecyu/Fe-Auto-Testing" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://github.com/Jecyu/Fe-Auto-Testing/tree/master" target="_blank" rel="noopener noreferrer" class="nav-link external">
  配套例子
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <a href="https://github.com/Jecyu/Fe-Auto-Testing" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><div class="sidebar-group first"><p class="sidebar-heading"><span>测试相关概念</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/Fe-Auto-Testing/concepts/" class="sidebar-link">Introduction</a></li><li><a href="/Fe-Auto-Testing/concepts/reason.html" class="sidebar-link">为什么要测试</a></li><li><a href="/Fe-Auto-Testing/concepts/type.html" class="sidebar-link">测试类型</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading open"><span>测试实战</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/Fe-Auto-Testing/practice/" class="sidebar-link">Introduction</a></li><li><a href="/Fe-Auto-Testing/practice/solution.html" class="sidebar-link">已有的解决方案</a></li><li><a href="/Fe-Auto-Testing/practice/mocha.html" class="sidebar-link">Mocha</a></li><li><a href="/Fe-Auto-Testing/practice/jest.html" class="active sidebar-link">Jest</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Fe-Auto-Testing/practice/jest.html#环境搭建" class="sidebar-link">环境搭建</a></li><li class="sidebar-sub-header"><a href="/Fe-Auto-Testing/practice/jest.html#mock-使用" class="sidebar-link">Mock 使用</a></li><li class="sidebar-sub-header"><a href="/Fe-Auto-Testing/practice/jest.html#添加-typescript-支持" class="sidebar-link">添加 TypeScript 支持</a></li><li class="sidebar-sub-header"><a href="/Fe-Auto-Testing/practice/jest.html#vscode-jest-插件，让测试结果更快呈现" class="sidebar-link">VSCode Jest 插件，让测试结果更快呈现</a></li><li class="sidebar-sub-header"><a href="/Fe-Auto-Testing/practice/jest.html#在-vscode-中调试-jest" class="sidebar-link">在 VSCode 中调试 Jest</a></li><li class="sidebar-sub-header"><a href="/Fe-Auto-Testing/practice/jest.html#让-jest-支持-es-module-模块" class="sidebar-link">让 Jest 支持 ES Module 模块</a></li><li class="sidebar-sub-header"><a href="/Fe-Auto-Testing/practice/jest.html#对-dom-进行测试" class="sidebar-link">对 DOM 进行测试</a></li><li class="sidebar-sub-header"><a href="/Fe-Auto-Testing/practice/jest.html#异常测试" class="sidebar-link">异常测试</a></li></ul></li><li><a href="/Fe-Auto-Testing/practice/vue.html" class="sidebar-link">测试 Vue.js 组件</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>持续集成自动化测试</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/Fe-Auto-Testing/auto/" class="sidebar-link">Introduction</a></li><li><a href="/Fe-Auto-Testing/auto/travis-ci.html" class="sidebar-link">Travis CI</a></li><li><a href="/Fe-Auto-Testing/auto/jenkins.html" class="sidebar-link">Jenkins</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>扩展</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/Fe-Auto-Testing/popularize/" class="sidebar-link">Introduction</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>Troubleshooting</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/Fe-Auto-Testing/tip/" class="sidebar-link">Introduction</a></li></ul></div></li><li><div class="sidebar-group"><p class="sidebar-heading"><span>参考资料</span> <!----></p> <ul class="sidebar-group-items"><li><a href="/Fe-Auto-Testing/refs/" class="sidebar-link">Introduction</a></li></ul></div></li></ul> </div> <div class="page"> <div class="content"><h1 id="jest"><a href="#jest" aria-hidden="true" class="header-anchor">#</a> Jest</h1> <h2 id="环境搭建"><a href="#环境搭建" aria-hidden="true" class="header-anchor">#</a> 环境搭建</h2> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">yarn</span> <span class="token function">add</span> jest --dev
</code></pre></div><p>添加到 package.json 中</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;test:unit&quot;</span><span class="token operator">:</span> <span class="token string">&quot;jest&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;devDependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;jest&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^24.8.0&quot;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="mock-使用"><a href="#mock-使用" aria-hidden="true" class="header-anchor">#</a> Mock 使用</h2> <p>mock 是一种通过用可以控制和检查的对象替换依赖项来隔离测试主题的技术。</p> <p>为什么需要 mock 函数呢？在项目中，一个模块的方法内常常会去调用另外一个模块的方法。在单元测试中，我们可能并不需要关心内部调用的方法的执行过程和结果，只想知道它是否被正确调用即可。</p> <ul><li>捕获函数的调用情况</li> <li>设置函数返回值</li> <li>改变函数的内部实现</li></ul> <img src="/Fe-Auto-Testing/assets/jest-mock.png"> <p>我们可以通过下面的 api 进行 mock 函数的创建：</p> <ul><li>jest.fn() mock 一个函数</li></ul> <div class="language-js extra-class"><pre class="language-js"><code><span class="token function">test</span><span class="token punctuation">(</span><span class="token string">&quot;returns undefined by default&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">const</span> mock <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> result <span class="token operator">=</span> <span class="token function">mock</span><span class="token punctuation">(</span><span class="token string">&quot;foo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">expect</span><span class="token punctuation">(</span>result<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeUndefined</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>mock<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenCalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>mock<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenCalledTimes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token function">expect</span><span class="token punctuation">(</span>mock<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenCalledWith</span><span class="token punctuation">(</span><span class="token string">&quot;foo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>jest.mock() mock 一个模块</li> <li>jest.spy() 用于监听模块行为</li></ul> <h3 id="mock-单个函数"><a href="#mock-单个函数" aria-hidden="true" class="header-anchor">#</a> mock 单个函数</h3> <h4 id="一个长轮询工具函数"><a href="#一个长轮询工具函数" aria-hidden="true" class="header-anchor">#</a> 一个长轮询工具函数</h4> <p>源代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * @class PollingAction
 * @param {Function}  callback[回调函数]
 * @param {Number}  time[轮询时间]
 * @param {immediate}  immediate[是否立即执行回调函数]
 * @description  通过给定的TIME进行轮询操作
 */</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token keyword">class</span> <span class="token class-name">PollingAction</span> <span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span><span class="token parameter">callback<span class="token punctuation">,</span> time <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">,</span> immediate <span class="token operator">=</span> <span class="token boolean">false</span></span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 执行状态</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>running <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token comment">// 轮询间隔</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>time <span class="token operator">=</span> time<span class="token punctuation">;</span>
    <span class="token comment">// 是否立即执行</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>immediate <span class="token operator">=</span> immediate<span class="token punctuation">;</span>
    <span class="token comment">// callback判断</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>callback<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> callback <span class="token operator">===</span> <span class="token string">&quot;function&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>callback <span class="token operator">=</span> callback<span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">&quot;参数1 必须是个函数&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>callback <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">// timer控制</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>timer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 执行轮询</span>
  <span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 是否立即执行</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>immediate<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>callback <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>running <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> <span class="token function-variable function">onAction</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>timer <span class="token operator">=</span> <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>running<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>callback <span class="token operator">&amp;&amp;</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token keyword">return</span> <span class="token function">onAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>time<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token function">onAction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">// 取消轮询</span>
  <span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>running <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>timer <span class="token operator">&amp;&amp;</span> <span class="token function">clearTimeout</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>timer<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>timer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>源代码主义看输入的参数以及功能函数如取消、启动，这样更方便我们写测试用例。下面是测试用例：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> PollingAction <span class="token keyword">from</span> <span class="token string">&quot;@/utils/pollingAction&quot;</span><span class="token punctuation">;</span>
<span class="token comment">// jest.useFakeTimers();</span>
<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">&quot;测试 pollAction轮询类&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">beforeEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> jest<span class="token punctuation">.</span><span class="token function">useFakeTimers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">test</span><span class="token punctuation">(</span><span class="token string">&quot;测试非立即执行轮询&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> time <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> callback <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> po <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PollingAction</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> time<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 触发轮询</span>
    po<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 此刻不应该触发回调，1000ms 后才触发</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">.</span>not<span class="token punctuation">.</span><span class="token function">toBeCalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 有2种时间快进方法</span>
    <span class="token comment">// jest.advanceTimersByTime(1000);</span>
    jest<span class="token punctuation">.</span><span class="token function">runOnlyPendingTimers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">expect</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeCalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenCalledTimes</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>setTimeout<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenLastCalledWith</span><span class="token punctuation">(</span>expect<span class="token punctuation">.</span><span class="token function">any</span><span class="token punctuation">(</span>Function<span class="token punctuation">)</span><span class="token punctuation">,</span> time<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 设置触发时机</span>

    <span class="token comment">// 消耗时间</span>
    jest<span class="token punctuation">.</span><span class="token function">runOnlyPendingTimers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenCalledTimes</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 第2次触发</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>setTimeout<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenLastCalledWith</span><span class="token punctuation">(</span>expect<span class="token punctuation">.</span><span class="token function">any</span><span class="token punctuation">(</span>Function<span class="token punctuation">)</span><span class="token punctuation">,</span> time<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// 取消轮询</span>
    po<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    jest<span class="token punctuation">.</span><span class="token function">runOnlyPendingTimers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenCalledTimes</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// po.cancel 生效，回调仍然只执行 2 次</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token function">test</span><span class="token punctuation">(</span><span class="token string">&quot;测试立即执行轮询&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> time <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> callback <span class="token operator">=</span> jest<span class="token punctuation">.</span><span class="token function">fn</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> po <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">PollingAction</span><span class="token punctuation">(</span>callback<span class="token punctuation">,</span> time<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    po<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// start 立马执行回调</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBeCalled</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    jest<span class="token punctuation">.</span><span class="token function">runOnlyPendingTimers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">expect</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenCalledTimes</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>setTimeout<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenLastCalledWith</span><span class="token punctuation">(</span>expect<span class="token punctuation">.</span><span class="token function">any</span><span class="token punctuation">(</span>Function<span class="token punctuation">)</span><span class="token punctuation">,</span> time<span class="token punctuation">)</span><span class="token punctuation">;</span>

    po<span class="token punctuation">.</span><span class="token function">cancel</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    jest<span class="token punctuation">.</span><span class="token function">runOnlyPendingTimers</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">expect</span><span class="token punctuation">(</span>callback<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenCalledTimes</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>注意 Jest 通过 <code>jest.fn()</code>来模拟一个函数，后面就可以实用 toHaveBeenCalledxxx 这些 api 方便我们调用函数了。</p> <h3 id="mock-整个包"><a href="#mock-整个包" aria-hidden="true" class="header-anchor">#</a> mock 整个包</h3> <h4 id="一个异步请求用户信息的例子"><a href="#一个异步请求用户信息的例子" aria-hidden="true" class="header-anchor">#</a> 一个异步请求用户信息的例子</h4> <p>待完成描述部分。建议直接去看附带的 demo，example/04-jest/mock-async 部分。</p> <h2 id="添加-typescript-支持"><a href="#添加-typescript-支持" aria-hidden="true" class="header-anchor">#</a> 添加 TypeScript 支持</h2> <p><a href="http://www.typescriptlang.org/" target="_blank" rel="noopener noreferrer">TypeScript<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 是 JavaScript 的一个超集，主要提供了类型系统和对 ES6 的支持，它由 Microsoft 开发，<a href="https://github.com/Microsoft/TypeScript" target="_blank" rel="noopener noreferrer">代码开源于 Github 上<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>。</p> <p>example/03-Jest/typeScript 目录</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">|</span> --src   <span class="token operator">|</span>
<span class="token operator">|</span> ------- <span class="token operator">|</span>
<span class="token operator">|</span> --      <span class="token operator">|</span>--<span class="token operator">|</span>__math.ts
<span class="token operator">|</span> --tests <span class="token operator">|</span>
<span class="token operator">|</span>         <span class="token operator">|</span>__math.spec.ts
</code></pre></div><ol><li>安装包 <code>yarn add typescript --dev</code>，然后把 <code>.js</code> 改为 <code>.ts</code> 扩展名，并根据 TypeScript 语法编写逻辑代码。</li></ol> <p>Before</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// math.js</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">sum</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 类型判断</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>
    <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token string">&quot;[object Number]&quot;</span> <span class="token operator">||</span>
    <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>b<span class="token punctuation">)</span> <span class="token operator">!==</span> <span class="token string">&quot;[object Number]&quot;</span>
  <span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">mul</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> a <span class="token operator">*</span> b<span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">sub</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> a <span class="token operator">-</span> b<span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">div</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">,</span> b</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> a <span class="token operator">/</span> b<span class="token punctuation">;</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// math.spec.js</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> sum <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../utils/math&quot;</span><span class="token punctuation">;</span>
<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">&quot;test math function&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">&quot;Adding 1 + 1 equals 2&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>After</p> <div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// math.ts //  TypeScript =&gt; 是用来定义函数的，函数左边是似乎如类型</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">sum</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> b<span class="token punctuation">:</span> <span class="token builtin">number</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function-variable function">number</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>
  <span class="token parameter">a<span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span>
  b<span class="token punctuation">:</span> <span class="token builtin">number</span></span>
<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token builtin">number</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">mul</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> b<span class="token punctuation">:</span> <span class="token builtin">number</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function-variable function">number</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>
  <span class="token parameter">a<span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span>
  b<span class="token punctuation">:</span> <span class="token builtin">number</span></span>
<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token builtin">number</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">sub</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> b<span class="token punctuation">:</span> <span class="token builtin">number</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function-variable function">number</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>
  <span class="token parameter">a<span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span>
  b<span class="token punctuation">:</span> <span class="token builtin">number</span></span>
<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token builtin">number</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">export</span> <span class="token keyword">const</span> <span class="token function-variable function">div</span><span class="token punctuation">:</span> <span class="token punctuation">(</span><span class="token parameter">a<span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span> b<span class="token punctuation">:</span> <span class="token builtin">number</span></span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function-variable function">number</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>
  <span class="token parameter">a<span class="token punctuation">:</span> <span class="token builtin">number</span><span class="token punctuation">,</span>
  b<span class="token punctuation">:</span> <span class="token builtin">number</span></span>
<span class="token punctuation">)</span><span class="token punctuation">:</span> <span class="token builtin">number</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> a <span class="token operator">+</span> b<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-ts extra-class"><pre class="language-ts"><code><span class="token comment">// math.spec.ts</span>
<span class="token keyword">import</span> <span class="token punctuation">{</span> sum <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">&quot;../src/utils/math&quot;</span><span class="token punctuation">;</span>
<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">&quot;test math function&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">&quot;Adding 1 + 1 equals 2&quot;</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">sum</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ol start="2"><li>在与 <code>package.json</code> 同目录下新增 <code>tsconfig.json</code>，添加 TypeScript 配置。</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token punctuation">{</span>
  <span class="token string">&quot;compilerOptions&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">{</span>
      <span class="token string">&quot;target&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;es5&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;strict&quot;</span><span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token string">&quot;include&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
      <span class="token string">&quot;src/**/*&quot;</span><span class="token punctuation">,</span>
      <span class="token string">&quot;tests/**/*&quot;</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token string">&quot;exclude&quot;</span><span class="token punctuation">:</span> <span class="token punctuation">[</span>
      <span class="token string">&quot;node_modules&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>这个时候使用 <code>tsc src/utils/math.ts</code> 可以成功对 ts 文件进行编译。</p> <ol start="3"><li>使用 Jest 测试 TypeScript 代码需要借助 <code>ts-jest</code> 解析器，而且需要 <code>@type/jest</code> 类型声明，避免找不到如 <code>describe</code> 模块。注意的是，如果在上述文件 <code>tsconfig.json</code> 中声明了 <code>types</code> 字段且不为空，这时候需要把 <code>jest</code> 字段添加进 <code>types</code> 里，这个设置是告诉 TypeScript 从 <code>@type</code> 包中寻找哪些声明文件。</li></ol> <p>所以需要安装依赖：
<code>yarn add ts-jest @types/jest --dev</code></p> <p>然后修改 <code>jest.config.js</code> 配置文件，将 ts 文件解析器设置为 <code>ts-jest</code>。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// jest.config.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  collectCoverage<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
  transform<span class="token punctuation">:</span> <span class="token punctuation">{</span>
    <span class="token string">&quot;^.+\\.tsx?$&quot;</span><span class="token punctuation">:</span> <span class="token string">&quot;ts-jest&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>另外，在 <code>package.json</code> 添加 scripts 测试命令。</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;typeScript&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;1.0.0&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;description&quot;</span><span class="token operator">:</span> <span class="token string">&quot;jest + ts&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;main&quot;</span><span class="token operator">:</span> <span class="token string">&quot;index.js&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;author&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Jecyu&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;license&quot;</span><span class="token operator">:</span> <span class="token string">&quot;MIT&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;scripts&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;test&quot;</span><span class="token operator">:</span> <span class="token string">&quot;jest&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;devDependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">&quot;@types/jest&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^25.1.2&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;jest&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^25.1.0&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;ts-jest&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^25.2.0&quot;</span><span class="token punctuation">,</span>
    <span class="token property">&quot;typescript&quot;</span><span class="token operator">:</span> <span class="token string">&quot;^3.7.5&quot;</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">&quot;dependencies&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>最后，运行 <code>yarn test</code> 即可测试 TypeScript 代码。</p> <h2 id="vscode-jest-插件，让测试结果更快呈现"><a href="#vscode-jest-插件，让测试结果更快呈现" aria-hidden="true" class="header-anchor">#</a> VSCode Jest 插件，让测试结果更快呈现</h2> <p>除了上面在项目中安装依赖包测试外，我们还可以安装 Jest 插件，先写好测试用例，然后一边实现一边查看测试的结果：</p> <p>具体步骤：</p> <ol><li>在 VSCode 中 “Jest” 插件并安装</li> <li>新建一个测试用例文件 <code>xxx.test.js</code>，不能是 js 后缀文件，否则插件不能识别。</li> <li>然后编写测试由用例。</li></ol> <p><img src="/Fe-Auto-Testing/assets/img/2020-08-27-21-44-46-test.4f2e1011.png" alt></p> <p>这样基本可以解决一些比较简单的测试用例，方便快捷，也不用安装依赖包。</p> <p><img src="/Fe-Auto-Testing/assets/img/2020-08-27-21-47-00-jest.f85deae9.png" alt></p> <p>双窗口开发查看。</p> <h2 id="在-vscode-中调试-jest"><a href="#在-vscode-中调试-jest" aria-hidden="true" class="header-anchor">#</a> 在 VSCode 中调试 Jest</h2> <p>如何测试驱动开发，最近在实现 Web 性能优化的 demo 中有了新的想法。比如要实现一个树类来说可以用 UML 图画出来，然后给该类或方法写出一些常见的的用法，也就是单元测试用例。在实现的过程中，可以对单元测试用例进行不断调试反馈。那如何在 VSCode 调试 Jest 呢：</p> <p>在项目根目录下，新建 <code>.vscode</code> 文件夹，新建文件 <code>launch.json</code>，然后复制下面的代码：</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
  <span class="token property">&quot;version&quot;</span><span class="token operator">:</span> <span class="token string">&quot;0.2.0&quot;</span><span class="token punctuation">,</span>
  <span class="token property">&quot;configurations&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">{</span>
      <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;Debug Jest Tests&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;node&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;request&quot;</span><span class="token operator">:</span> <span class="token string">&quot;launch&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;runtimeArgs&quot;</span><span class="token operator">:</span> <span class="token punctuation">[</span>
        <span class="token string">&quot;--inspect-brk&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;${workspaceRoot}/node_modules/.bin/jest&quot;</span><span class="token punctuation">,</span>
        <span class="token string">&quot;--runInBand&quot;</span>
      <span class="token punctuation">]</span><span class="token punctuation">,</span>
      <span class="token property">&quot;console&quot;</span><span class="token operator">:</span> <span class="token string">&quot;integratedTerminal&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;internalConsoleOptions&quot;</span><span class="token operator">:</span> <span class="token string">&quot;neverOpen&quot;</span><span class="token punctuation">,</span>
      <span class="token property">&quot;port&quot;</span><span class="token operator">:</span> <span class="token number">9229</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">]</span>
<span class="token punctuation">}</span>
</code></pre></div><p>然后在对应的测试文件设置断点调试即可，保证文件模块用的是 CommonJS 规范定义。</p> <p>如果是测试文件采用了 ES Module 的，会出现下面描述的错误需要额外配置，下面我们看看如何让 Jest 支持 ES Module 模块。</p> <h2 id="让-jest-支持-es-module-模块"><a href="#让-jest-支持-es-module-模块" aria-hidden="true" class="header-anchor">#</a> 让 Jest 支持 ES Module 模块</h2> <p>Jest 默认只支持 CommonJs 模块规范引入，如果你使用 ES Module 引入的话，则会报以下的错误：</p> <div class="language-bash extra-class"><pre class="language-bash"><code> FAIL  packages/_utils/tests/base.spec.js
  ● Test suite failed to run

    Jest encountered an unexpected token

    This usually means that you are trying to <span class="token function">import</span> a <span class="token function">file</span> <span class="token function">which</span> Jest cannot parse, e.g. it<span class="token string">'s not plain JavaScript.

    By default, if Jest sees a Babel config, it will use that to transform your files, ignoring &quot;node_modules&quot;.

    Here'</span>s what you can do:
     • To have some of your <span class="token string">&quot;node_modules&quot;</span> files transformed, you can specify a custom <span class="token string">&quot;transformIgnorePatterns&quot;</span> <span class="token keyword">in</span> your config.
     • If you need a custom transformation specify a <span class="token string">&quot;transform&quot;</span> option <span class="token keyword">in</span> your config.
     • If you simply want to mock your non-JS modules <span class="token punctuation">(</span>e.g. binary assets<span class="token punctuation">)</span> you can stub them out with the <span class="token string">&quot;moduleNameMapper&quot;</span> config option.

    You'll <span class="token function">find</span> <span class="token function">more</span> details and examples of these config options <span class="token keyword">in</span> the docs:
    https://jestjs.io/docs/en/configuration.html

    Details:

    /Users/linjy/Documents/Developer/Frontend/Easy-Wheels/packages/_utils/tests/base.spec.js:1
    <span class="token function">import</span> <span class="token punctuation">{</span> type, isArray, slice, each, setAttr <span class="token punctuation">}</span> from <span class="token string">&quot;../base&quot;</span><span class="token punctuation">;</span>
           ^

    SyntaxError: Unexpected token <span class="token punctuation">{</span>

      at Runtime._execModule <span class="token punctuation">(</span>node_modules/jest-runtime/build/index.js:1179:56<span class="token punctuation">)</span>
</code></pre></div><p>方案如下：</p> <ol><li>需要安装必要的依赖：</li></ol> <div class="language-sh extra-class"><pre class="language-text"><code>yarn add --dev babel-jest @babel/core @babel/preset-env
</code></pre></div><p>或者</p> <div class="language-sh extra-class"><pre class="language-text"><code>npm install --save-dev babel-jest @babel/core @babel/preset-env
</code></pre></div><ol start="2"><li>然后在根文件夹下创建 <code>babel.config.js</code> 文件，并复制下面的代码：</li></ol> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// babel.config.js</span>
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  presets<span class="token punctuation">:</span> <span class="token punctuation">[</span>
    <span class="token punctuation">[</span>
      <span class="token string">&quot;@babel/preset-env&quot;</span><span class="token punctuation">,</span>
      <span class="token punctuation">{</span>
        targets<span class="token punctuation">:</span> <span class="token punctuation">{</span>
          node<span class="token punctuation">:</span> <span class="token string">&quot;current&quot;</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">]</span><span class="token punctuation">,</span>
  <span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><ol start="3"><li>确保在 <code>package.json</code> and <code>jest.config.js</code> 中 Jest 是默认配置。</li> <li>Jest 会默认读取 babel 的配置，通过 base-jest 对 ES Module 的代码进行转换为 CommonJS。</li></ol> <h2 id="对-dom-进行测试"><a href="#对-dom-进行测试" aria-hidden="true" class="header-anchor">#</a> 对 DOM 进行测试</h2> <p>jest 单元测试具有 dom 的页面，使用原生 HTML（比如 Vue） or 使用 JSDOM。</p> <p>https://www.npmjs.com/package/jsdom</p> <h2 id="异常测试"><a href="#异常测试" aria-hidden="true" class="header-anchor">#</a> 异常测试</h2> <p>源代码：</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">/**
 * Multiplies a value by 2.
 * @param value
 * @returns
 * @anotherNote
 */</span>
<span class="token keyword">function</span> <span class="token function">double</span><span class="token punctuation">(</span><span class="token parameter">value<span class="token punctuation">:</span> number</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>value <span class="token operator">&lt;=</span> Number<span class="token punctuation">.</span><span class="token constant">MIN_VALUE</span> <span class="token operator">||</span> value <span class="token operator">&gt;=</span> Number<span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Error</span><span class="token punctuation">(</span><span class="token string">'The number is out of range that can be represented.'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> value <span class="token operator">*</span> <span class="token number">2</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">export</span> <span class="token keyword">default</span> double
</code></pre></div><p>使用 <code>toThrow</code> 获得错误输出的信息。</p> <div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">import</span> double <span class="token keyword">from</span> <span class="token string">'../src/double'</span>
<span class="token function">describe</span><span class="token punctuation">(</span><span class="token string">'double'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should error if get number in the valid range.'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">double</span><span class="token punctuation">(</span>Number<span class="token punctuation">.</span><span class="token constant">MAX_VALUE</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toThrow</span><span class="token punctuation">(</span><span class="token string">'The number is out of range that can be represented.'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>

  <span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should input a number and get it doubled'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token function">double</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toBe</span><span class="token punctuation">(</span><span class="token number">4</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

</code></pre></div></div> <div class="page-edit"><div class="edit-link"><a href="https://github.com/Jecyu/Fe-Auto-Testing/edit/master/docs/practice/jest.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">上次更新: </span> <span class="time">4/20/2021, 4:09:06 PM</span></div></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/Fe-Auto-Testing/practice/mocha.html" class="prev">
          Mocha
        </a></span> <span class="next"><a href="/Fe-Auto-Testing/practice/vue.html">
          测试 Vue.js 组件
        </a>
        →
      </span></p></div> </div> <!----></div></div>
    <script src="/Fe-Auto-Testing/assets/js/app.092a0afe.js" defer></script><script src="/Fe-Auto-Testing/assets/js/3.b3f65018.js" defer></script>
  </body>
</html>
